# LaiYu液体处理设备硬件连接配置指南

## 📋 概述

本指南详细说明如何配置LaiYu液体处理设备的硬件连接参数，包括串口配置、设备地址设置和连接状态验证。

## 🔌 硬件连接架构

LaiYu液体处理设备包含两个主要硬件组件：

### 1. XYZ三轴步进电机控制器
- **通信协议**: RS485 (Modbus)
- **默认波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无

### 2. SOPA气动式移液器
- **通信协议**: RS485
- **默认波特率**: 115200  
- **设备地址**: 1-254 (禁用: 47, 69, 91)
- **通信类型**: 终端调试模式 ("/") 或 OEM通信模式 ("[")

## ⚙️ 配置文件修改

### 1. 主配置文件位置

配置参数主要在以下文件中设置：

#### A. 设备配置类 (`LaiYu_Liquid.py`)
```python
@dataclass
class LaiYuLiquidConfig:
    # 串口连接参数
    port: str = "/dev/cu.usbserial-3130"  # 🔧 修改这里的串口号
    address: int = 1                       # 🔧 修改设备地址
    baudrate: int = 9600                   # 🔧 修改波特率
    timeout: float = 5.0                   # 🔧 修改超时时间
    
    # 工作台物理尺寸
    deck_width: float = 340.0              # 工作台宽度 (mm)
    deck_height: float = 250.0             # 工作台高度 (mm) 
    deck_depth: float = 160.0              # 工作台深度 (mm)
    
    # 其他参数...
```

#### B. 实验配置文件 (`test/experiments/laiyu_liquid.json`)
```json
{
    "config": {
        "port": "/dev/cu.usbserial-3130",    // 🔧 修改串口号
        "address": 1,                        // 🔧 修改设备地址
        "baudrate": 9600,                    // 🔧 修改波特率
        "timeout": 5.0,                      // 🔧 修改超时时间
        "deck_width": 340.0,
        "deck_height": 250.0,
        "deck_depth": 160.0
        // 其他配置...
    }
}
```

### 2. 串口号识别和配置

#### macOS系统
```bash
# 查看所有串口设备
ls /dev/cu.*

# 常见的串口设备名称
/dev/cu.usbserial-*     # USB转串口设备
/dev/cu.usbmodem*       # USB调制解调器
/dev/cu.SLAB_USBtoUART  # Silicon Labs CP210x
/dev/cu.wchusbserial*   # WCH CH340/CH341
```

#### Linux系统
```bash
# 查看串口设备
ls /dev/ttyUSB* /dev/ttyACM*

# 查看设备详细信息
dmesg | grep tty
lsusb
```

#### Windows系统
```bash
# 在设备管理器中查看"端口(COM和LPT)"
# 常见格式: COM1, COM2, COM3...
```

### 3. 控制器特定配置

#### XYZ控制器配置 (`controllers/xyz_controller.py`)
```python
def __init__(self, port: str, baudrate: int = 115200, 
             machine_config: Optional[MachineConfig] = None,
             config_file: str = "machine_config.json",
             auto_connect: bool = True):
    """
    Args:
        port: 串口端口 (如: "/dev/cu.usbserial-3130")
        baudrate: 波特率 (默认: 115200)
        machine_config: 机械配置参数
        config_file: 配置文件路径
        auto_connect: 是否自动连接
    """
```

#### 移液器控制器配置 (`controllers/pipette_controller.py`)
```python
@dataclass
class SOPAConfig:
    # 通信参数
    port: str = "/dev/ttyUSB0"              # 🔧 修改串口号
    baudrate: int = 115200                  # 🔧 修改波特率
    address: int = 1                        # 🔧 修改设备地址 (1-254)
    timeout: float = 5.0                    # 🔧 修改超时时间
    comm_type: CommunicationType = CommunicationType.TERMINAL_DEBUG
```

## 🔍 连接状态验证

### 1. 编程方式验证连接

#### 创建测试脚本
```python
#!/usr/bin/env python3
"""
LaiYu液体处理设备连接测试脚本
"""

import sys
import os
sys.path.append('/Users/dp/Documents/DPT/HuaiRou/Uni-Lab-OS')

from unilabos.devices.LaiYu_Liquid.LaiYu_Liquid import (
    LaiYuLiquid, LaiYuLiquidConfig
)

def test_connection():
    """测试设备连接"""
    
    # 🔧 修改这里的配置参数
    config = LaiYuLiquidConfig(
        port="/dev/cu.usbserial-3130",  # 修改为你的串口号
        address=1,                       # 修改为你的设备地址
        baudrate=9600,                   # 修改为你的波特率
        timeout=5.0
    )
    
    print("🔌 正在测试LaiYu液体处理设备连接...")
    print(f"串口: {config.port}")
    print(f"波特率: {config.baudrate}")
    print(f"设备地址: {config.address}")
    print("-" * 50)
    
    try:
        # 创建设备实例
        device = LaiYuLiquid(config)
        
        # 尝试连接和初始化
        print("📡 正在连接设备...")
        success = await device.setup()
        
        if success:
            print("✅ 设备连接成功!")
            print(f"连接状态: {device.is_connected}")
            print(f"初始化状态: {device.is_initialized}")
            print(f"当前位置: {device.current_position}")
            
            # 获取设备状态
            status = device.get_status()
            print("\n📊 设备状态:")
            for key, value in status.items():
                print(f"  {key}: {value}")
                
        else:
            print("❌ 设备连接失败!")
            print("请检查:")
            print("  1. 串口号是否正确")
            print("  2. 设备是否已连接并通电")
            print("  3. 波特率和设备地址是否匹配")
            print("  4. 串口是否被其他程序占用")
            
    except Exception as e:
        print(f"❌ 连接测试出错: {e}")
        print("\n🔧 故障排除建议:")
        print("  1. 检查串口设备是否存在:")
        print("     macOS: ls /dev/cu.*")
        print("     Linux: ls /dev/ttyUSB* /dev/ttyACM*")
        print("  2. 检查设备权限:")
        print("     sudo chmod 666 /dev/cu.usbserial-*")
        print("  3. 检查设备是否被占用:")
        print("     lsof | grep /dev/cu.usbserial")
        
    finally:
        # 清理连接
        if 'device' in locals():
            await device.stop()

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_connection())
```

### 2. 命令行验证工具

#### 串口通信测试
```bash
# 安装串口调试工具
pip install pyserial

# 使用Python测试串口
python -c "
import serial
try:
    ser = serial.Serial('/dev/cu.usbserial-3130', 9600, timeout=1)
    print('串口连接成功:', ser.is_open)
    ser.close()
except Exception as e:
    print('串口连接失败:', e)
"
```

#### 设备权限检查
```bash
# macOS/Linux 检查串口权限
ls -la /dev/cu.usbserial-*

# 如果权限不足，修改权限
sudo chmod 666 /dev/cu.usbserial-*

# 检查串口是否被占用
lsof | grep /dev/cu.usbserial
```

### 3. 连接状态指示器

设备提供多种方式检查连接状态：

#### A. 属性检查
```python
device = LaiYuLiquid(config)

# 检查连接状态
print(f"设备已连接: {device.is_connected}")
print(f"设备已初始化: {device.is_initialized}")
print(f"枪头已安装: {device.tip_attached}")
print(f"当前位置: {device.current_position}")
print(f"当前体积: {device.current_volume}")
```

#### B. 状态字典
```python
status = device.get_status()
print("完整设备状态:", status)

# 输出示例:
# {
#     'connected': True,
#     'initialized': True, 
#     'position': (0.0, 0.0, 50.0),
#     'tip_attached': False,
#     'current_volume': 0.0,
#     'last_error': None
# }
```

## 🚨 常见问题和解决方案

### 1. 串口连接失败

**问题**: `serial.serialutil.SerialException: could not open port`

**解决方案**:
```bash
# 1. 检查串口是否存在
ls /dev/cu.*

# 2. 检查权限
sudo chmod 666 /dev/cu.usbserial-*

# 3. 检查是否被占用
lsof | grep /dev/cu.usbserial

# 4. 重新插拔USB设备
```

### 2. 设备地址冲突

**问题**: 多个设备使用相同地址

**解决方案**:
- XYZ控制器: 地址 1-3 (对应X、Y、Z轴)
- 移液器: 地址 4 (避免与步进电机冲突)
- 禁用地址: 47 ('/'), 69 ('E'), 91 ('[')

### 3. 波特率不匹配

**问题**: 通信乱码或无响应

**解决方案**:
```python
# 常见波特率设置
baudrate_options = [9600, 19200, 38400, 57600, 115200]

# 逐一测试
for baudrate in baudrate_options:
    try:
        config.baudrate = baudrate
        device = LaiYuLiquid(config)
        if await device.setup():
            print(f"正确波特率: {baudrate}")
            break
    except:
        continue
```

### 4. 超时问题

**问题**: 设备响应缓慢

**解决方案**:
```python
# 增加超时时间
config.timeout = 10.0  # 从5秒增加到10秒

# 或在控制器级别设置
xyz_controller = XYZController(port, timeout=10.0)
pipette_controller = PipetteController(port, timeout=10.0)
```

## 📝 配置文件模板

### 完整配置示例
```json
{
    "laiyu_liquid_config": {
        "communication": {
            "xyz_controller": {
                "port": "/dev/cu.usbserial-3130",
                "baudrate": 115200,
                "timeout": 5.0
            },
            "pipette_controller": {
                "port": "/dev/cu.usbserial-3131", 
                "baudrate": 115200,
                "address": 4,
                "timeout": 5.0
            }
        },
        "mechanical": {
            "deck_width": 340.0,
            "deck_height": 250.0,
            "deck_depth": 160.0,
            "safe_height": 50.0
        },
        "motion": {
            "max_speed": 100.0,
            "acceleration": 50.0,
            "tip_pickup_speed": 30,
            "tip_pickup_acceleration": 500
        },
        "safety": {
            "position_validation": true,
            "emergency_stop_enabled": true,
            "deck_width": 300.0,
            "deck_height": 200.0,
            "deck_depth": 100.0,
            "safe_height": 50.0
        }
    }
}
```

## 🔧 调试和日志

### 启用详细日志
```python
import logging

# 设置日志级别
logging.basicConfig(level=logging.DEBUG)

# 或针对特定模块
logger = logging.getLogger('unilabos.devices.LaiYu_Liquid')
logger.setLevel(logging.DEBUG)
```

### 通信调试
```python
# 在控制器中启用调试模式
xyz_controller = XYZController(port, debug=True)
pipette_controller = PipetteController(port, debug=True)
```

